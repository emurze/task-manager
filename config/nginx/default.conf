worker_processes 4;

events {
    worker_connections 10240;  # Высокое количество одновременных соединений
    multi_accept on;           # Принимать несколько соединений одновременно
    use epoll;                 # Оптимальный метод для Linux
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Оптимизация буферов
    sendfile on;                     # Использование sendfile для отправки файлов
    tcp_nopush on;                   # Сокращение числа пакетов TCP
    tcp_nodelay on;                  # Ускорение передачи мелких данных
    client_header_buffer_size 1k;    # Размер буфера для заголовков клиента
    client_body_buffer_size 8k;      # Размер буфера для тела запроса клиента
    client_max_body_size 50m;        # Ограничение размера тела запроса
    large_client_header_buffers 4 16k;

    # Keep-alive настройки
    keepalive_timeout 65;            # Увеличение таймаута keep-alive
    keepalive_requests 1000;         # Количество запросов на одном соединении

    # Лимиты и таймауты
    reset_timedout_connection on;    # Закрывать таймаут соединения
    send_timeout 15;                 # Таймаут отправки данных клиенту

    # Сжатие
    gzip on;
    gzip_comp_level 5;               # Уровень компрессии (баланс между скоростью и эффективностью)
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_http_version 1.1;

    gzip_types
        application/javascript
        application/x-javascript
        application/json
        application/xml
        text/css
        text/javascript
        text/plain
        text/xml
        font/eot
        font/otf
        font/ttf
        image/svg+xml;

    gzip_disable "msie6";

    # Балансировка нагрузки (upstream)
    upstream cluster {
        ip_hash;                     # Сохранение сессий клиентов
        server api:8080 max_fails=3 fail_timeout=30s;
        server api2:8081 max_fails=3 fail_timeout=30s;
    }

    # Настройки сервера
    server {
        listen 80 default_server;
        server_name _;

        # Основное приложение
        location / {
            proxy_ignore_client_abort on;
            proxy_pass http://cluster;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_redirect off;

            # Буферизация прокси
            proxy_buffering on;
            proxy_buffers 16 16k;
            proxy_busy_buffers_size 24k;
            proxy_max_temp_file_size 256m;
        }

        # Статические файлы
        location /static/ {
            alias /srv/static/;
            access_log off;          # Отключение логов для статики
            expires max;             # Кэширование статики
        }

        location /media/ {
            alias /srv/media/;
            access_log off;
            expires max;
        }
    }
}